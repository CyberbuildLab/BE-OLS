name: Collect Ontology Submissions

on:
  issues:
    types: [opened]

jobs:
  export:
    runs-on: ubuntu-latest

    steps:
      - name: Check out repo
        uses: actions/checkout@v3

      # -------- Parse the issue body --------
      - name: Extract form data
        id: form
        uses: actions/github-script@v6
        with:
          script: |
            const issue = context.payload.issue
            const lines = issue.body.split(/\r?\n/)
            const data  = {}

            let currentKey = null
            for (const ln of lines) {
              const heading = ln.match(/^###\s+(.*)/)      // '### Name'
              if (heading) {                               // start of a new field
                currentKey = heading[1].trim()
                continue
              }
              if (!currentKey) continue                    // not inside a field yet
              if (ln.trim() === '') continue               // skip blank lines
              data[currentKey] = ln.trim()                 // first non-blank line = answer
              currentKey = null                            // reset for the next heading
            }

            if (!Object.keys(data).length) {
              core.setFailed('No form fields found – is this the right template?')
            }

            // expose as output called 'json'
            core.setOutput('json', JSON.stringify(data, null, 2))

      # -------- Write JSON to repo --------
      - name: Save JSON
        run: |
          mkdir -p data/submissions
          echo '${{ steps.form.outputs.json }}' \
            > "data/submissions/submission_${{ github.event.issue.number }}.json"

      # -------- Convert JSON → Excel --------
      - name: Install Python deps
        run: |
          python -m pip install --upgrade pip
          pip install pandas openpyxl

      - name: JSON → Excel
        run: |
          python create_submission_excel.py \
            "data/submissions/submission_${{ github.event.issue.number }}.json" \
            "data/submissions/submission_${{ github.event.issue.number }}.xlsx"

      # -------- Commit both files --------
      - name: Commit submission files
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add "data/submissions/submission_${{ github.event.issue.number }}.json"
          git add "data/submissions/submission_${{ github.event.issue.number }}.xlsx"
          git commit -m "Add submission #${{ github.event.issue.number }}" || echo "Nothing to commit"
          git push
